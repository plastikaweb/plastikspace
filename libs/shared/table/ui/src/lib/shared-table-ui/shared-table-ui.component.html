<div
  class="z-10 block mt-0 overflow-auto border-t border-solid md:mt-4 border-gray-10 table-wrapper">
  <mat-table
    class="table w-full table-fixed"
    matSort
    matSortDisableClear
    [dataSource]="dataSource"
    [attr.aria-label]="caption()"
    [matSortActive]="matSort?.active || ''"
    [matSortDirection]="matSort?.direction || ''"
    (matSortChange)="onChangeSorting($event)">
    @if (caption()) {
      <caption class="sr-only">
        {{
          caption()
        }}
      </caption>
    }

    @for (column of columnProperties(); track column.key) {
      <ng-container [matColumnDef]="column.key" [sticky]="column.sticky">
        <mat-header-cell
          *matHeaderCellDef
          [mat-sort-header]="column.key"
          [disabled]="!column.sorting"
          [ngClass]="column.cssClasses?.[0] || ''">
          {{ column.title }}
        </mat-header-cell>

        <mat-cell
          *matCellDef="let row; let i = index"
          [plastikTableCellTitle]="column.showTitle ?? true"
          [ngClass]="column.cssClasses?.[0] || ''">
          @switch (column.formatting.type) {
            @case ('LINK') {
              <div
                class="cursor-pointer table__cell--link"
                tabindex="0"
                [innerHTML]="row | safeFormatted: column : i + 1"
                (click)="onGetRoute($event)"
                (keyup)="onGetRoute($event)"></div>
            }
            @case ('INPUT') {
              @if (column.isEditableConfig?.(row); as editable) {
                @let attributes = editable?.attributes;
                <mat-form-field
                  #matFormField
                  class="inline editable"
                  [ngClass]="attributes?.styles || ''">
                  @if (attributes?.prefix) {
                    <span matTextPrefix>{{ attributes?.prefix }}</span>
                  }

                  @if (isText(editable)) {
                    <input
                      matInput
                      [value]="row[column.key]"
                      [placeholder]="editable.attributes.placeholder || ''"
                      (change)="onInputChange($event, row, editable)" />
                  }

                  @if (isNumber(editable)) {
                    <input
                      matInput
                      type="number"
                      [value]="row[column.key]"
                      [attr.min]="editable.attributes.min || 0"
                      [attr.max]="editable.attributes.max || 100"
                      [attr.step]="editable.attributes.step || 1"
                      [placeholder]="editable.attributes.placeholder || ''"
                      (change)="onInputChange($event, row, editable)" />
                  }

                  @if (isSelect(editable)) {
                    <mat-select
                      [value]="row[column.key]"
                      [multiple]="editable.attributes.multiple || false"
                      (selectionChange)="onInputChange($event, row, editable)">
                      @for (option of editable.attributes.options; track option.value) {
                        <mat-option [value]="option.value">
                          {{ option.label }}
                        </mat-option>
                      }
                    </mat-select>
                  }

                  @if (isCheckBox(editable)) {
                    <mat-checkbox
                      [value]="row[column.key]"
                      [checked]="editable.attributes.checked || false"
                      (change)="onInputChange($event, row, editable)"></mat-checkbox>
                  }

                  @if (isRadio(editable)) {
                    <mat-radio-group
                      [value]="row[column.key]"
                      (change)="onInputChange($event, row, editable)">
                      @for (option of editable.attributes.options; track option.value) {
                        <mat-radio-button [value]="option.value">
                          {{ option.label }}
                        </mat-radio-button>
                      }
                    </mat-radio-group>
                  }

                  @if (isTextarea(editable)) {
                    <textarea
                      matInput
                      [value]="row[column.key]"
                      [placeholder]="editable.attributes.placeholder || ''"
                      [rows]="editable.attributes.rows || 2"
                      (change)="onInputChange($event, row, editable)"></textarea>
                  }

                  @if (attributes?.suffix) {
                    <span matTextSuffix>{{ attributes?.suffix }}</span>
                  }
                </mat-form-field>
              }
            }

            @default {
              <div
                [ngClass]="column.cssClasses?.[1] || ''"
                [innerHTML]="row | safeFormatted: column : i + 1 : pagination()"></div>
            }
          }
        </mat-cell>
      </ng-container>
    }

    <!-- Actions column -->
    @if (actions()) {
      <ng-container matColumnDef="actions">
        <mat-header-cell
          *matHeaderCellDef
          class="flex mat-cell-actions gap-sub min-w-fit"></mat-header-cell>
        <mat-cell *matCellDef="let element" class="flex mat-cell-actions gap-sub min-w-fit">
          @for (action of actions() | keyvalue | orderTableActionsElements; track action.key) {
            @if (action.key === 'EDIT') {
              <button
                type="button"
                mat-icon-button
                [routerLink]="action.value?.link ? action.value?.link(element) : [element.id]"
                [attr.aria-label]="action.value?.description(element) || ''"
                [matTooltip]="action.value?.description(element) || ''"
                [disabled]="action.value?.disabled ? action.value?.disabled(element) : false">
                <mat-icon class="mat-primary">edit</mat-icon>
              </button>
            } @else if (action.value?.visible(element) && action.value?.type === 'input') {
              <button
                type="button"
                mat-icon-button
                [attr.aria-label]="action.value?.description(element) || ''"
                [matTooltip]="action.value?.description(element) || ''"
                [disabled]="action.value?.disabled ? action.value?.disabled(element) : false"
                (click)="getChangedData.emit(action.value?.execute(element))">
                <mat-icon class="mat-warn">delete</mat-icon>
              </button>
            } @else if (action.key === 'DELETE' && action.value?.visible(element)) {
              <button
                type="button"
                mat-icon-button
                [attr.aria-label]="action.value?.description(element) || ''"
                [matTooltip]="action.value?.description(element) || ''"
                [disabled]="action.value?.disabled ? action.value?.disabled(element) : false"
                (click)="onDelete($event, element)">
                <mat-icon class="mat-warn">delete</mat-icon>
              </button>
            } @else if (action.value?.visible(element)) {
              <div class="table-actions-grouping">
                <button
                  type="button"
                  mat-icon-button
                  [attr.aria-label]="action.value?.description(element) || ''"
                  [matTooltip]="action.value?.description(element) || ''"
                  [disabled]="action.value?.disabled ? action.value?.disabled(element) : false"
                  (click)="$event.stopPropagation(); action.value?.execute?.(element)">
                  <mat-icon class="mat-primary">{{ action.value?.icon(element) }}</mat-icon>
                </button>
              </div>
            }
          }
        </mat-cell>
      </ng-container>
    }

    <mat-header-row *matHeaderRowDef="displayedColumns(); sticky: true"></mat-header-row>
    <mat-row
      *matRowDef="let row; columns: displayedColumns()"
      class="even:bg-gray-5 odd:bg-white"
      [ngClass]="extraRowStyles()?.(row) || ''"></mat-row>
  </mat-table>

  @if (!noPagination()) {
    <mat-paginator
      #matPaginator
      class="mt-md jus"
      [hidePageSize]="paginationVisibility()?.hidePageSize"
      [length]="resultsLength()"
      [ngClass]="{
        'paginator--hide': paginationVisibility()?.hideRangeLabel,
        'paginator--hide-range-buttons': paginationVisibility()?.hideRangeButtons,
      }"
      [pageIndex]="pagination()?.pageIndex || 0"
      [pageSize]="pagination()?.pageSize || resultsLength()"
      [pageSizeOptions]="pageSizeOptions()"
      [showFirstLastButtons]="!paginationVisibility()?.hidePaginationFirstLastButtons"
      (page)="onChangePagination($event)">
    </mat-paginator>
  }

  @if (!dataSource.data.length) {
    <ng-content select="[noResults]"></ng-content>
    <ng-content select="[noValidSearch]"></ng-content>
  }

  <ng-template #noResults>
    <ng-content select="[noResults]"></ng-content>
    <ng-content select="[noValidSearch]"></ng-content>
  </ng-template>
</div>
